<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Posture Tracker (Adafruit IO)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=IBM+Plex+Sans:wght@400;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0F1923;--card:#1C2D3F;--muted:#2A3F55;--text:#E6EDF3;--dim:#6B7280;
  --good:#2DD4A0;--warn:#FBBF24;--bad:#F87171
}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans',sans-serif;min-height:100vh}
.wrap{max-width:640px;margin:0 auto;padding:20px 16px}
h1{font-family:'DM Serif Display',serif;font-size:28px;margin-bottom:2px}
.sub{font-size:12px;color:var(--dim);margin-bottom:18px}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
.pill{border:1px solid rgba(42,63,85,.6);background:rgba(28,45,63,.5);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--dim)}
.pill b{color:var(--text);font-weight:600}
.live{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px}
.col{display:flex;flex-direction:column;align-items:center}
.col.right{justify-content:center}
.fig{width:180px;height:240px;position:relative}
.fig-glow{position:absolute;inset:10%;border-radius:50%;filter:blur(30px);transition:background 0.8s}
.fig svg{position:relative;z-index:2;width:100%;height:100%}
.fig svg *{transition:all 0.45s cubic-bezier(.34,1.56,.64,1)}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 16px;border-radius:999px;font-size:13px;font-weight:600;letter-spacing:.5px;border:1px solid;margin-top:10px;transition:all .4s}
.dot{width:8px;height:8px;border-radius:50%;position:relative}
.dot::before{content:'';position:absolute;inset:0;border-radius:50%;animation:ping 1.5s ease-out infinite}
@keyframes ping{75%,100%{transform:scale(2);opacity:0}}
.badge.good{background:rgba(45,212,160,.12);border-color:rgba(45,212,160,.3);color:var(--good)}
.badge.good .dot,.badge.good .dot::before{background:var(--good)}
.badge.slouching{background:rgba(248,113,113,.12);border-color:rgba(248,113,113,.3);color:var(--bad)}
.badge.slouching .dot,.badge.slouching .dot::before{background:var(--bad)}
.badge.offline{background:rgba(107,114,128,.12);border-color:rgba(107,114,128,.3);color:var(--dim)}
.badge.offline .dot{background:var(--dim)}
.badge.offline .dot::before{animation:none}
.gauge{width:180px}
.glabel{text-align:center;margin-top:8px}
.glabel .num{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:600}
.glabel .dim{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.card{background:var(--card);border:1px solid rgba(42,63,85,.5);border-radius:12px;padding:12px 14px}
.card-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.card-lbl{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.8px}
.card-val{font-family:'DM Serif Display',serif;font-size:22px}
.chart-section h2{font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:10px}
.chart-box{background:var(--card);border:1px solid rgba(42,63,85,.5);border-radius:16px;padding:16px}
#chart{width:100%;height:220px}
.empty{display:flex;align-items:center;justify-content:center;height:220px;color:var(--dim);font-size:14px}
.foot{text-align:center;padding:18px 0;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);border-top:1px solid rgba(42,63,85,.3);margin-top:16px}
.confetti-box{position:fixed;inset:0;pointer-events:none;z-index:100;overflow:hidden}
.confetti-bit{position:absolute;width:8px;height:8px;border-radius:2px;top:-10px;opacity:0;animation:fall 2s ease-out forwards}
@keyframes fall{0%{opacity:1;transform:translateY(0) rotate(0)}100%{opacity:0;transform:translateY(100vh) rotate(720deg)}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Posture Tracker</h1>
  <p class="sub">Custom animated dashboard (data from Adafruit IO)</p>

  <div class="row">
    <div class="pill">Status: <b id="pillStatus">connecting</b></div>
    <div class="pill">Angle: <b id="pillAngle">--</b>°</div>
    <div class="pill">Slouches: <b id="pillCount">--</b></div>
    <div class="pill">Last update: <b id="pillTime">--</b></div>
  </div>

  <div class="live">
    <div class="col">
      <div class="fig">
        <div class="fig-glow" id="glow"></div>
        <svg viewBox="0 0 200 280" id="figSvg"></svg>
      </div>
      <div id="badge" class="badge offline">
        <span class="dot"></span>
        <span id="badgeTxt">CONNECTING...</span>
      </div>
    </div>
    <div class="col right">
      <div class="gauge"><svg viewBox="0 0 160 100" id="gaugeSvg"></svg></div>
      <div class="glabel">
        <div class="num" id="angTxt">--</div>
        <div class="dim">deviation from baseline</div>
      </div>
    </div>
  </div>

  <div class="cards">
    <div class="card">
      <div class="card-top"><span class="card-lbl">Slouches</span></div>
      <div class="card-val" id="mCount">--</div>
    </div>
    <div class="card">
      <div class="card-top"><span class="card-lbl">Connection</span></div>
      <div class="card-val" id="mConn">--</div>
    </div>
  </div>

  <div class="chart-section">
    <h2>Angle Timeline</h2>
    <div class="chart-box">
      <canvas id="chart"></canvas>
      <div class="empty" id="noData">Collecting data...</div>
    </div>
  </div>

  <div class="foot">No Feather webserver • Just feeds → website</div>
</div>
<div class="confetti-box" id="confetti"></div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */

// Feed keys (must match what Feather publishes to)
const FEED_ANGLE  = "posture-angle";
const FEED_STATUS = "posture-status";
const FEED_COUNT  = "slouch-count";

// UI behavior
const THRESH = 4;          // slouch threshold (visual)
let MAXG = 20;             // gauge max; auto-expands if you exceed it
const POLL_MS = 500;      // live polling
const HIST_MS = 5000;     // history polling
const HIST_LIMIT = 200;    // points to fetch from AIO
let prev = "offline";

/** =========================
 *  AIO HTTP helpers
 *  ========================= */
function aioUrl(path){ return `https://io.adafruit.com/api/v2/${AIO_USER}${path}`; }

function withKey(url){
  const join = url.includes("?") ? "&" : "?";
  return url + join + "x-aio-key=" + encodeURIComponent(AIO_KEY);
}

function aioFetch(path){
  // calls Netlify function, which adds the key server-side
  return fetch(`/.netlify/functions/aio?path=${encodeURIComponent(path)}`)
    .then(r => {
      if(!r.ok) throw new Error(`AIO ${r.status}`);
      return r.json();
    });
}

async function aioLast(feed){
  return aioFetch(`/feeds/${encodeURIComponent(feed)}/data/last`);
}

async function aioHistory(feed, limit){
  return aioFetch(`/feeds/${encodeURIComponent(feed)}/data?limit=${limit}`);
}

/** =========================
 *  Drawing / animation
 *  ========================= */
function drawFig(a, st){
  const svg=document.getElementById('figSvg');
  const gl=document.getElementById('glow');
  const C={good:{s:'#3FB950',p:'#2DD4A0',g:'rgba(45,212,160,.15)'},
           slouching:{s:'#F87171',p:'#EF4444',g:'rgba(248,113,113,.15)'},
           offline:{s:'#4B5563',p:'#6B7280',g:'rgba(75,85,99,.1)'}};
  const c=C[st]||C.offline;
  gl.style.background=c.g;

  const vt=Math.min(a*2.3,40),r=vt*Math.PI/180;
  const sn=Math.sin(r),cs=Math.cos(r);
  const hx=100,hy=185,tl=90;
  const sx=hx-sn*tl,sy=hy-cs*tl;
  const nx=sx-sn*12,ny=sy-cs*12;
  const dx=nx-sn*20,dy=ny-cs*20;
  const ex=sx-8,ey=sy+40,fx=ex-25,fy=ey-8+vt*.3;
  const cb=vt<20?80*(1-vt/20):0;

  let h='';
  h+='<rect x="'+(hx-35)+'" y="'+(hy+2)+'" width="65" height="8" rx="3" fill="#4B5563"/>';
  h+='<line x1="'+(hx-30)+'" y1="'+(hy+10)+'" x2="'+(hx-35)+'" y2="'+(hy+45)+'" stroke="#4B5563" stroke-width="5" stroke-linecap="round"/>';
  h+='<line x1="'+(hx+25)+'" y1="'+(hy+10)+'" x2="'+(hx+30)+'" y2="'+(hy+45)+'" stroke="#4B5563" stroke-width="5" stroke-linecap="round"/>';
  if(cb>4)h+='<rect x="'+(hx+23)+'" y="'+(hy-cb)+'" width="8" height="'+cb+'" rx="4" fill="#4B5563"/>';
  h+='<line x1="'+(hx-3)+'" y1="'+(hy+3)+'" x2="'+(hx-45)+'" y2="'+(hy+40)+'" stroke="#374151" stroke-width="10" stroke-linecap="round"/>';
  h+='<line x1="'+(hx-45)+'" y1="'+(hy+40)+'" x2="'+(hx-45)+'" y2="'+(hy+80)+'" stroke="#374151" stroke-width="10" stroke-linecap="round"/>';
  h+='<rect x="'+(hx-57)+'" y="'+(hy+78)+'" width="18" height="6" rx="3" fill="#1F2937"/>';
  h+='<line x1="'+hx+'" y1="'+hy+'" x2="'+sx+'" y2="'+sy+'" stroke="'+c.s+'" stroke-width="16" stroke-linecap="round"/>';
  for(let i=0;i<7;i++){
    const f=i/6,px=hx+(sx-hx)*f,py=hy+(sy-hy)*f;
    const cv=Math.sin(f*Math.PI)*(vt/40)*18;
    h+='<circle cx="'+(px+12+cv)+'" cy="'+py+'" r="3" fill="'+c.p+'"/>';
  }
  h+='<line x1="'+sx+'" y1="'+sy+'" x2="'+nx+'" y2="'+ny+'" stroke="#FFCC99" stroke-width="6" stroke-linecap="round"/>';
  h+='<circle cx="'+dx+'" cy="'+dy+'" r="20" fill="#FFCC99"/>';
  h+='<ellipse cx="'+dx+'" cy="'+(dy-6)+'" rx="18" ry="12" fill="#4A3728"/>';
  h+='<circle cx="'+(dx-6)+'" cy="'+(dy+4)+'" r="13" fill="#FFCC99"/>';
  h+='<circle cx="'+(dx-12)+'" cy="'+(dy+1)+'" r="2" fill="#1F2937"/>';
  if(st==='good')h+='<path d="M '+(dx-15)+' '+(dy+7)+' Q '+(dx-12)+' '+(dy+12)+' '+(dx-9)+' '+(dy+7)+'" stroke="#1F2937" stroke-width="2" fill="none" stroke-linecap="round"/>';
  else if(st==='slouching')h+='<path d="M '+(dx-15)+' '+(dy+11)+' Q '+(dx-12)+' '+(dy+6)+' '+(dx-9)+' '+(dy+11)+'" stroke="#1F2937" stroke-width="2" fill="none" stroke-linecap="round"/>';
  else h+='<line x1="'+(dx-15)+'" y1="'+(dy+9)+'" x2="'+(dx-9)+'" y2="'+(dy+9)+'" stroke="#1F2937" stroke-width="2" stroke-linecap="round"/>';
  h+='<line x1="'+(sx-3)+'" y1="'+(sy+6)+'" x2="'+ex+'" y2="'+ey+'" stroke="'+c.s+'" stroke-width="8" stroke-linecap="round"/>';
  h+='<line x1="'+ex+'" y1="'+ey+'" x2="'+fx+'" y2="'+fy+'" stroke="#FFCC99" stroke-width="6" stroke-linecap="round"/>';
  h+='<circle cx="'+fx+'" cy="'+fy+'" r="5" fill="#FFCC99"/>';
  if(vt>8)h+='<rect x="5" y="'+(fy+6)+'" width="'+(fx-3)+'" height="5" rx="2" fill="#4B5563" opacity=".7"/>';
  svg.innerHTML=h;
}

function arcPath(cx,cy,r,sa,ea){
  const sr=sa*Math.PI/180,er=ea*Math.PI/180;
  const x1=cx+r*Math.cos(sr),y1=cy+r*Math.sin(sr);
  const x2=cx+r*Math.cos(er),y2=cy+r*Math.sin(er);
  return 'M '+x1+' '+y1+' A '+r+' '+r+' 0 '+((ea-sa)>180?1:0)+' 1 '+x2+' '+y2;
}

function drawGauge(a,st){
  const svg=document.getElementById('gaugeSvg');
  const col=st==='good'?'#2DD4A0':st==='slouching'?'#F87171':'#6B7280';

  // auto-expand gauge range if you exceed it
  if(a > MAXG) MAXG = Math.ceil(a/10)*10;

  const pct=Math.min(a/MAXG,1);
  const r=70,cx=80,cy=85,sa=-180,ea=0;
  const sw=sa+pct*(ea-sa);
  const nr=sw*Math.PI/180;
  const nx=cx+r*.85*Math.cos(nr),ny=cy+r*.85*Math.sin(nr);

  const tp=THRESH/MAXG,ta=(sa+tp*(ea-sa))*Math.PI/180;
  const t1x=cx+(r-8)*Math.cos(ta),t1y=cy+(r-8)*Math.sin(ta);
  const t2x=cx+(r+8)*Math.cos(ta),t2y=cy+(r+8)*Math.sin(ta);

  svg.innerHTML=
    '<path d="'+arcPath(cx,cy,r,sa,ea)+'" fill="none" stroke="#2A3F55" stroke-width="10" stroke-linecap="round"/>'
    +'<line x1="'+t1x+'" y1="'+t1y+'" x2="'+t2x+'" y2="'+t2y+'" stroke="#E6EDF3" stroke-width="2" opacity=".3"/>'
    +'<path d="'+arcPath(cx,cy,r,sa,sw)+'" fill="none" stroke="'+col+'" stroke-width="10" stroke-linecap="round"/>'
    +'<line x1="'+cx+'" y1="'+cy+'" x2="'+nx+'" y2="'+ny+'" stroke="'+col+'" stroke-width="3" stroke-linecap="round"/>'
    +'<circle cx="'+cx+'" cy="'+cy+'" r="5" fill="#E6EDF3"/>'
    +'<text x="8" y="92" font-size="7" fill="#6B7280" font-family="JetBrains Mono,monospace">0</text>'
    +'<text x="140" y="92" font-size="7" fill="#6B7280" font-family="JetBrains Mono,monospace">'+MAXG+'</text>';

  const el=document.getElementById('angTxt');
  el.textContent=a.toFixed(1)+'\u00B0';
  el.style.color=col;
}

function setBadge(st){
  const b=document.getElementById('badge');
  const t=document.getElementById('badgeTxt');
  b.className='badge '+st;
  if(st==='good') t.textContent='GOOD POSTURE';
  else if(st==='slouching') t.textContent='SLOUCHING';
  else t.textContent='OFFLINE';
}

function boom(){
  const box=document.getElementById('confetti');
  const cols=['#2DD4A0','#3FB950','#34D399','#6EE7B7','#A7F3D0'];
  for(let i=0;i<40;i++){
    const p=document.createElement('div');
    p.className='confetti-bit';
    p.style.left=(10+Math.random()*80)+'%';
    p.style.background=cols[Math.floor(Math.random()*cols.length)];
    p.style.animationDelay=(Math.random()*.5)+'s';
    p.style.width=(5+Math.random()*6)+'px';
    p.style.height=(5+Math.random()*6)+'px';
    box.appendChild(p);
    setTimeout(()=>p.remove(),2500);
  }
}

function drawChart(samples){
  const canvas=document.getElementById('chart');
  const empty=document.getElementById('noData');
  if(!samples || samples.length<2){canvas.style.display='none';empty.style.display='flex';return;}
  canvas.style.display='block';empty.style.display='none';

  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*dpr; canvas.height=220*dpr;
  canvas.style.width=rect.width+'px'; canvas.style.height='220px';
  ctx.setTransform(dpr,0,0,dpr,0,0);

  const W=rect.width,H=220;
  const p={t:18,r:10,b:30,l:40};
  const gw=W-p.l-p.r, gh=H-p.t-p.b;

  let maxA=Math.max(MAXG, ...samples.map(s=>s.a))*1.1;
  const t0=samples[0].t, t1=samples[samples.length-1].t, tR=Math.max(t1-t0,1);
  const tx=t=>p.l+((t-t0)/tR)*gw;
  const ty=a=>p.t+gh-(a/maxA)*gh;

  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#1C2D3F'; ctx.lineWidth=1;
  for(let a=0;a<=maxA;a+=10){
    const y=ty(a);
    ctx.beginPath(); ctx.moveTo(p.l,y); ctx.lineTo(W-p.r,y); ctx.stroke();
  }

  // threshold line
  ctx.strokeStyle='rgba(248,113,113,.35)'; ctx.setLineDash([6,4]);
  ctx.beginPath(); ctx.moveTo(p.l,ty(THRESH)); ctx.lineTo(W-p.r,ty(THRESH)); ctx.stroke();
  ctx.setLineDash([]);

  // area under curve
  const gr=ctx.createLinearGradient(0,p.t,0,H-p.b);
  gr.addColorStop(0,'rgba(45,212,160,.22)'); gr.addColorStop(1,'rgba(45,212,160,0)');
  ctx.beginPath();
  ctx.moveTo(tx(samples[0].t),ty(0));
  for(const s of samples) ctx.lineTo(tx(s.t),ty(s.a));
  ctx.lineTo(tx(samples[samples.length-1].t),ty(0));
  ctx.closePath();
  ctx.fillStyle=gr; ctx.fill();

  // line
  ctx.beginPath();
  ctx.moveTo(tx(samples[0].t),ty(samples[0].a));
  for(let i=1;i<samples.length;i++) ctx.lineTo(tx(samples[i].t),ty(samples[i].a));
  ctx.strokeStyle='#2DD4A0'; ctx.lineWidth=2; ctx.stroke();

  // axes labels
  ctx.fillStyle='#6B7280';
  ctx.font='10px JetBrains Mono,monospace';
  ctx.textAlign='right';
  for(let a=0;a<=maxA;a+=20) ctx.fillText(a+'\u00B0',p.l-6,ty(a)+4);

  ctx.textAlign='center';
  const step=Math.max(1,Math.floor(samples.length/5));
  for(let i=0;i<samples.length;i+=step){
    const d=new Date(samples[i].t*1000);
    const lbl=('0'+d.getHours()).slice(-2)+':'+('0'+d.getMinutes()).slice(-2);
    ctx.fillText(lbl,tx(samples[i].t),H-p.b+16);
  }
}

/** =========================
 *  Live polling from AIO
 *  ========================= */
function normalizeStatus(s){
  s = (s||"").toLowerCase().trim();
  if(s.includes("good")) return "good";
  if(s.includes("slouch")) return "slouching";
  return "offline";
}

async function pollLive(){
  try{
    const [aLast, sLast, cLast] = await Promise.all([
      aioLast(FEED_ANGLE),
      aioLast(FEED_STATUS),
      aioLast(FEED_COUNT),
    ]);

    const angle = parseFloat(aLast.value);
    const status = normalizeStatus(String(sLast.value));
    const count = parseInt(cLast.value,10) || 0;

    // UI text
    document.getElementById('pillStatus').textContent = status;
    document.getElementById('pillAngle').textContent  = isFinite(angle)? angle.toFixed(1) : "--";
    document.getElementById('pillCount').textContent  = count;
    document.getElementById('pillTime').textContent   = new Date(aLast.created_at).toLocaleTimeString();
    document.getElementById('mCount').textContent     = count;
    document.getElementById('mConn').textContent      = "online";

    // Draw
    const a = isFinite(angle) ? angle : 0;
    drawFig(a, status);
    drawGauge(a, status);
    setBadge(status);

    if(prev==="slouching" && status==="good") boom();
    prev = status;

  }catch(e){
    document.getElementById('mConn').textContent = "offline";
    drawFig(0,"offline");
    drawGauge(0,"offline");
    setBadge("offline");
  }
}

async function pollHist(){
  try{
    const rows = await aioHistory(FEED_ANGLE, HIST_LIMIT);
    // AIO returns newest-first; reverse it.
    const samples = rows
      .slice()
      .reverse()
      .map(r => ({
        t: Math.floor(Date.parse(r.created_at)/1000),
        a: parseFloat(r.value)
      }))
      .filter(s => isFinite(s.a) && isFinite(s.t));

    drawChart(samples);
  }catch(e){
    // ignore
  }
}

// boot
drawFig(0,"offline");
drawGauge(0,"offline");
pollLive();
setTimeout(pollHist, 800);
setInterval(pollLive, POLL_MS);
setInterval(pollHist, HIST_MS);
</script>
</body>
</html>
